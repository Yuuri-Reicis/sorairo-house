<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SORAIRO House</title>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <style>
        /* ========================================
           åŸºæœ¬ã‚¹ã‚¿ã‚¤ãƒ« - ãƒ‘ã‚¹ãƒ†ãƒ«ã‚«ãƒ©ãƒ¼ãƒ†ãƒ¼ãƒ
        ======================================== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', 'Yu Gothic UI', 'Meiryo', sans-serif;
            background: linear-gradient(135deg, #f5f0ff 0%, #fce4ec 100%);
            min-height: 100vh;
            display: flex;
        }

        /* ========================================
           ãƒ¡ã‚¤ãƒ³ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆï¼ˆã‚µã‚¤ãƒ‰ãƒãƒ¼ + ãƒ¡ã‚¤ãƒ³ï¼‰
        ======================================== */
        .app-container {
            display: flex;
            width: 100%;
            height: 100vh;
        }

        /* ========================================
           ã‚µã‚¤ãƒ‰ãƒãƒ¼
        ======================================== */
        .sidebar {
            width: 280px;
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border-right: 1px solid #e0d4f0;
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
        }

        .sidebar-header {
            padding: 16px;
            border-bottom: 1px solid #e0d4f0;
        }

        .sidebar-header h2 {
            font-size: 1.2rem;
            color: #7c6a9a;
            margin-bottom: 12px;
        }

        .new-session-btn {
            width: 100%;
            padding: 10px 16px;
            background: linear-gradient(135deg, #c9b8e8 0%, #e8a0b5 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .new-session-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(201, 184, 232, 0.4);
        }

        .search-box {
            padding: 12px 16px;
            border-bottom: 1px solid #e0d4f0;
        }

        .search-input {
            width: 100%;
            padding: 8px 12px;
            border: 2px solid #e0d4f0;
            border-radius: 8px;
            font-size: 0.85rem;
            background: #faf8ff;
            transition: all 0.3s ease;
        }

        .search-input:focus {
            outline: none;
            border-color: #c9b8e8;
        }

        .session-list {
            flex: 1;
            overflow-y: auto;
            padding: 8px;
        }

        /* ã‚µã‚¤ãƒ‰ãƒãƒ¼ä¸Šéƒ¨ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ï¼ˆè¨­å®šãƒ»ãƒ­ã‚°ã‚¤ãƒ³ï¼‰ */
        .sidebar-top-controls {
            padding: 12px 16px;
            border-bottom: 1px solid #e0d4f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        /* ã‚µã‚¤ãƒ‰ãƒãƒ¼ä¸‹éƒ¨ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ï¼ˆAPIã‚­ãƒ¼ãƒ»ãƒ¢ãƒ‡ãƒ«ï¼‰ */
        .sidebar-bottom-controls {
            padding: 12px 16px;
            border-top: 1px solid #e0d4f0;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .sidebar-api-row {
            display: flex;
            gap: 8px;
        }

        .api-key-input-sidebar {
            width: 100%;
            padding: 8px 10px;
            border: 2px solid #e0d4f0;
            border-radius: 8px;
            font-size: 0.8rem;
            background: #faf8ff;
        }

        .api-key-input-sidebar:focus {
            outline: none;
            border-color: #c9b8e8;
        }

        .model-select-sidebar {
            flex: 1;
            padding: 6px 8px;
            border: 2px solid #e0d4f0;
            border-radius: 8px;
            font-size: 0.8rem;
            background: #faf8ff;
            color: #7c6a9a;
        }

        /* å·¦ã‚µã‚¤ãƒ‰ãƒãƒ¼é–‹é–‰ãƒœã‚¿ãƒ³ï¼ˆã‚¹ãƒãƒ›ç”¨ï¼‰ */
        .sidebar-toggle {
            display: none;
            position: fixed;
            left: 16px;
            top: 16px;
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: linear-gradient(135deg, #c9b8e8 0%, #e8a0b5 100%);
            color: white;
            border: none;
            font-size: 1.2rem;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(201, 184, 232, 0.4);
            z-index: 999;
            transition: transform 0.2s;
        }

        .sidebar-toggle:hover {
            transform: scale(1.1);
        }

        .sidebar-close {
            display: none;
            background: none;
            border: none;
            font-size: 1.2rem;
            cursor: pointer;
            color: #9a8ab0;
        }

        .session-item {
            padding: 12px;
            margin-bottom: 4px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .session-item:hover {
            background: #f5f0ff;
        }

        .session-item.active {
            background: linear-gradient(135deg, #e8ddf5 0%, #fce4ec 100%);
        }

        .session-info {
            flex: 1;
            min-width: 0;
        }

        .session-name {
            font-size: 0.9rem;
            color: #5a4a6a;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .session-preview {
            font-size: 0.75rem;
            color: #9a8ab0;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            margin-top: 4px;
        }

        .session-actions {
            display: flex;
            gap: 4px;
            opacity: 1;
            /* å¸¸ã«è¡¨ç¤º */
            flex-shrink: 0;
        }

        .session-item:hover .session-actions {
            opacity: 1;
        }

        .session-action-btn {
            padding: 6px 10px;
            border: none;
            border-radius: 6px;
            background: #e0d4f0;
            /* è–„ç´«ã®èƒŒæ™¯ */
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.2s;
        }

        .session-action-btn:hover {
            background: #c9b8e8;
            /* ãƒ›ãƒãƒ¼æ™‚ã«æ¿ƒã */
            transform: scale(1.1);
        }

        /* ========================================
           ãƒ¡ã‚¤ãƒ³ã‚¨ãƒªã‚¢
        ======================================== */
        .main-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 20px;
            min-width: 0;
        }

        /* ãƒ˜ãƒƒãƒ€ãƒ¼ */
        .header {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            padding: 16px 20px;
            margin-bottom: 16px;
            box-shadow: 0 4px 20px rgba(200, 180, 220, 0.2);
        }

        .header h1 {
            font-size: 1.4rem;
            color: #7c6a9a;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .header h1::before {
            content: 'ğŸ’¬';
        }

        .header-controls {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            align-items: center;
        }

        .api-key-input {
            flex: 1;
            min-width: 200px;
            padding: 10px 14px;
            border: 2px solid #e0d4f0;
            border-radius: 10px;
            font-size: 0.9rem;
            transition: all 0.3s ease;
            background: #faf8ff;
        }

        .api-key-input:focus {
            outline: none;
            border-color: #c9b8e8;
            box-shadow: 0 0 0 3px rgba(201, 184, 232, 0.3);
        }

        .btn {
            padding: 10px 18px;
            border: none;
            border-radius: 10px;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
        }

        .btn-primary {
            background: linear-gradient(135deg, #c9b8e8 0%, #e8a0b5 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(201, 184, 232, 0.4);
        }

        .btn-secondary {
            background: #f0e8f8;
            color: #7c6a9a;
        }

        .btn-secondary:hover {
            background: #e8ddf5;
        }

        .model-select {
            padding: 10px 14px;
            border: 2px solid #e0d4f0;
            border-radius: 10px;
            font-size: 0.9rem;
            background: #faf8ff;
            color: #7c6a9a;
            cursor: pointer;
        }

        .api-status {
            width: 100%;
            margin-top: 8px;
            font-size: 0.85rem;
            color: #9a8ab0;
        }

        .api-status.saved {
            color: #6ab29b;
        }

        /* ãƒãƒ£ãƒƒãƒˆã‚¨ãƒªã‚¢ */
        .chat-area {
            flex: 1;
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            padding: 20px;
            overflow-y: auto;
            margin-bottom: 16px;
            box-shadow: 0 4px 20px rgba(200, 180, 220, 0.2);
        }

        .message {
            display: flex;
            margin-bottom: 16px;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message.user {
            justify-content: flex-end;
        }

        .message.assistant {
            justify-content: flex-start;
        }

        .message-bubble {
            max-width: 80%;
            padding: 12px 16px;
            border-radius: 18px;
            line-height: 1.5;
            word-break: break-word;
        }

        .message.user .message-bubble {
            background: linear-gradient(135deg, #ffe4ec 0%, #ffd6e7 100%);
            color: #8a6070;
            border-bottom-right-radius: 6px;
            width: fit-content;
            margin-left: auto;
        }

        .message.assistant .message-bubble {
            background: linear-gradient(135deg, #e0f5ee 0%, #d4f0e8 100%);
            color: #5a7a6a;
            border-bottom-left-radius: 6px;
        }

        .message-label {
            font-size: 0.75rem;
            margin-bottom: 4px;
            opacity: 0.7;
        }

        .message.user .message-label {
            text-align: right;
            color: #b08090;
        }

        .message.assistant .message-label {
            text-align: left;
            color: #70a090;
        }

        /* ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚° */
        .loading {
            display: flex;
            gap: 4px;
            padding: 12px 16px;
        }

        .loading-dot {
            width: 8px;
            height: 8px;
            background: #a0d0c0;
            border-radius: 50%;
            animation: bounce 1.4s infinite ease-in-out;
        }

        .loading-dot:nth-child(1) {
            animation-delay: -0.32s;
        }

        .loading-dot:nth-child(2) {
            animation-delay: -0.16s;
        }

        .loading-dot:nth-child(3) {
            animation-delay: 0s;
        }

        @keyframes bounce {

            0%,
            80%,
            100% {
                transform: scale(0);
            }

            40% {
                transform: scale(1);
            }
        }

        /* ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ */
        .message-actions {
            display: flex;
            gap: 6px;
            margin-top: 6px;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .message:hover .message-actions {
            opacity: 1;
        }

        .message-action-btn {
            padding: 4px 8px;
            font-size: 0.75rem;
            background: rgba(255, 255, 255, 0.7);
            border: 1px solid #e0d4f0;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            color: #7c6a9a;
        }

        .message-action-btn:hover {
            background: #f0e8f8;
            transform: scale(1.05);
        }

        /* å…¥åŠ›ã‚¨ãƒªã‚¢ */
        .input-area {
            display: flex;
            gap: 10px;
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            padding: 14px;
            box-shadow: 0 4px 20px rgba(200, 180, 220, 0.2);
        }

        .message-input {
            flex: 1;
            padding: 12px 16px;
            border: 2px solid #e0d4f0;
            border-radius: 12px;
            font-size: 1rem;
            resize: none;
            min-height: 48px;
            max-height: 120px;
            font-family: inherit;
            background: #faf8ff;
            transition: all 0.3s ease;
        }

        .message-input:focus {
            outline: none;
            border-color: #c9b8e8;
            box-shadow: 0 0 0 3px rgba(201, 184, 232, 0.3);
        }

        .send-btn {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
        }

        .send-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* ãƒˆãƒ¼ã‚¯ãƒ³è¡¨ç¤º */
        .token-display-area {
            margin-top: 8px;
            padding: 8px 12px;
            background: rgba(255, 255, 255, 0.5);
            border-radius: 10px;
        }

        .token-display {
            font-size: 0.8rem;
            color: #9a8ab0;
            text-align: center;
        }

        .token-stats {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            margin-top: 4px;
            font-size: 0.75rem;
            color: #b0a0c0;
        }

        .token-reset-btn {
            padding: 4px 8px;
            font-size: 0.8rem;
            background: #f0e8f8;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .token-reset-btn:hover {
            background: #e8ddf5;
            transform: scale(1.1);
        }

        /* ãƒ•ãƒƒã‚¿ãƒ¼ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ« */
        .footer-controls {
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
            align-items: center;
            gap: 10px;
            margin-top: 8px;
            padding: 10px 14px;
            background: rgba(255, 255, 255, 0.6);
            border-radius: 12px;
        }

        .api-controls {
            display: flex;
            align-items: center;
            gap: 8px;
            flex-wrap: wrap;
        }

        .api-key-input-small {
            width: 160px;
            padding: 6px 10px;
            border: 1px solid #e0d4f0;
            border-radius: 6px;
            font-size: 0.8rem;
            background: #faf8ff;
        }

        .api-key-input-small:focus {
            outline: none;
            border-color: #c9b8e8;
        }

        .model-select-small {
            padding: 6px 10px;
            border: 1px solid #e0d4f0;
            border-radius: 6px;
            font-size: 0.8rem;
            background: #faf8ff;
            color: #7c6a9a;
        }

        .btn-small {
            padding: 6px 12px;
            font-size: 0.8rem;
            background: linear-gradient(135deg, #c9b8e8 0%, #e8a0b5 100%);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-small:hover {
            transform: translateY(-1px);
        }

        .api-status-small {
            font-size: 0.75rem;
            color: #6ab29b;
        }

        .token-info {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 0.8rem;
            color: #9a8ab0;
        }

        .token-date {
            font-size: 0.75rem;
            color: #b0a0c0;
        }

        .footer-actions {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* ç©ºçŠ¶æ…‹ */
        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: #b0a0c0;
            text-align: center;
        }

        .empty-state-icon {
            font-size: 4rem;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        .empty-state-text {
            font-size: 1.1rem;
        }

        /* ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ */
        .error-message {
            background: #ffe0e0;
            color: #a05050;
            padding: 12px 16px;
            border-radius: 12px;
            margin-bottom: 16px;
            font-size: 0.9rem;
        }

        /* ãƒ•ã‚¡ã‚¤ãƒ«ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ */
        .file-preview {
            background: rgba(255, 255, 255, 0.9);
            border-radius: 12px;
            padding: 12px;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 12px;
            box-shadow: 0 2px 10px rgba(200, 180, 220, 0.2);
        }

        .file-preview-content {
            flex: 1;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .file-preview-image {
            max-width: 100px;
            max-height: 80px;
            border-radius: 8px;
            object-fit: cover;
        }

        .file-preview-text {
            font-size: 0.85rem;
            color: #5a4a6a;
            max-width: 300px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .file-preview-close {
            background: #e0d4f0;
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            cursor: pointer;
            font-size: 1rem;
            color: #7c6a9a;
            transition: all 0.2s;
        }

        .file-preview-close:hover {
            background: #c9b8e8;
        }

        /* æ·»ä»˜ãƒœã‚¿ãƒ³ */
        .attach-btn {
            padding: 10px 14px;
            background: #f0e8f8;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 1.1rem;
            transition: all 0.2s;
        }

        .attach-btn:hover {
            background: #e8ddf5;
            transform: scale(1.05);
        }

        /* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ– */
        @media (max-width: 768px) {
            .sidebar {
                position: fixed;
                left: -280px;
                top: 0;
                height: 100vh;
                z-index: 1000;
                transition: left 0.3s ease;
            }

            .sidebar.open {
                left: 0;
            }

            .sidebar-toggle {
                display: block;
            }
        }

        /* ========================================
           è¨­å®šãƒ¢ãƒ¼ãƒ€ãƒ«
        ======================================== */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 2000;
            justify-content: center;
            align-items: center;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal {
            background: white;
            border-radius: 16px;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
        }

        .modal-header {
            padding: 20px;
            border-bottom: 1px solid #e0d4f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h2 {
            color: #7c6a9a;
            font-size: 1.2rem;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #9a8ab0;
        }

        .modal-body {
            padding: 20px;
        }

        .form-group {
            margin-bottom: 16px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #5a4a6a;
            font-weight: 500;
        }

        .form-group textarea {
            width: 100%;
            min-height: 150px;
            padding: 12px;
            border: 2px solid #e0d4f0;
            border-radius: 10px;
            font-size: 0.9rem;
            font-family: inherit;
            resize: vertical;
        }

        .form-group textarea:focus {
            outline: none;
            border-color: #c9b8e8;
        }

        .modal-footer {
            padding: 16px 20px;
            border-top: 1px solid #e0d4f0;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        .settings-btn {
            padding: 10px 14px;
            background: #f0e8f8;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 1.1rem;
            transition: all 0.2s;
        }

        .settings-btn:hover {
            background: #e8ddf5;
            transform: scale(1.05);
        }

        /* ãƒ­ã‚°ã‚¤ãƒ³ãƒœã‚¿ãƒ³ */
        .auth-area {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .login-btn {
            padding: 8px 14px;
            background: linear-gradient(135deg, #4285f4 0%, #34a853 100%);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.85rem;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: all 0.2s;
        }

        .login-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(66, 133, 244, 0.3);
        }

        .logout-btn {
            padding: 6px 10px;
            background: #f0e8f8;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.8rem;
            transition: all 0.2s;
        }

        .logout-btn:hover {
            background: #e8ddf5;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.85rem;
            color: #7c6a9a;
        }

        .user-avatar {
            width: 28px;
            height: 28px;
            border-radius: 50%;
        }

        .sync-status {
            font-size: 0.75rem;
            padding: 4px 8px;
            background: #e8f5e9;
            color: #2e7d32;
            border-radius: 4px;
        }

        .sync-status.syncing {
            background: #fff3e0;
            color: #e65100;
        }

        /* ========================================
           å³ã‚µã‚¤ãƒ‰ãƒãƒ¼ï¼ˆåœ§ç¸®å±¥æ­´ãƒ‘ãƒãƒ«ï¼‰
        ======================================== */
        .history-panel {
            width: 280px;
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border-left: 1px solid #e0d4f0;
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
            transition: transform 0.3s ease;
        }

        .history-panel-header {
            padding: 16px;
            border-bottom: 1px solid #e0d4f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .history-panel-header h3 {
            font-size: 1rem;
            color: #7c6a9a;
            margin: 0;
        }

        .history-panel-toggle {
            display: none;
            position: fixed;
            right: 16px;
            top: 16px;
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: linear-gradient(135deg, #c9b8e8 0%, #e8a0b5 100%);
            color: white;
            border: none;
            font-size: 1.2rem;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(201, 184, 232, 0.4);
            z-index: 999;
            transition: transform 0.2s;
        }

        .history-panel-toggle:hover {
            transform: scale(1.1);
        }

        .history-panel-close {
            display: none;
            background: none;
            border: none;
            font-size: 1.2rem;
            cursor: pointer;
            color: #9a8ab0;
        }

        .history-list {
            flex: 1;
            overflow-y: auto;
            padding: 12px;
        }

        .history-item {
            padding: 10px 12px;
            margin-bottom: 8px;
            background: rgba(240, 232, 248, 0.5);
            border-radius: 10px;
            font-size: 0.85rem;
            color: #5a4a6a;
            line-height: 1.4;
        }

        .history-item-turn {
            font-size: 0.7rem;
            color: #9a8ab0;
            margin-bottom: 4px;
        }

        .history-empty {
            text-align: center;
            color: #b0a0c0;
            padding: 20px;
            font-size: 0.9rem;
        }

        .history-panel-footer {
            padding: 12px 16px;
            border-top: 1px solid #e0d4f0;
            font-size: 0.8rem;
            color: #9a8ab0;
        }

        .history-panel-footer .token-display {
            display: block;
            margin-bottom: 6px;
        }

        .token-footer-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        /* ã‚¹ãƒãƒ›å¯¾å¿œ */
        @media (max-width: 1024px) {

            /* å·¦ã‚µã‚¤ãƒ‰ãƒãƒ¼ */
            .sidebar {
                position: fixed;
                left: -280px;
                top: 0;
                height: 100vh;
                z-index: 1000;
                transition: left 0.3s ease;
            }

            .sidebar.open {
                left: 0;
            }

            .sidebar-toggle {
                display: block;
            }

            .sidebar-close {
                display: block;
            }

            /* å³ã‚µã‚¤ãƒ‰ãƒãƒ¼ */
            .history-panel {
                position: fixed;
                right: -280px;
                top: 0;
                height: 100vh;
                z-index: 1000;
            }

            .history-panel.open {
                right: 0;
            }

            .history-panel-toggle {
                display: block;
            }

            .history-panel-close {
                display: block;
            }

            /* ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼šãƒ•ãƒ©ãƒƒãƒˆè¡¨ç¤º */
            .message.assistant .message-bubble {
                background: none;
                max-width: 100%;
                padding: 8px 0;
                border-radius: 0;
                border-left: 3px solid #a0d0c0;
                padding-left: 12px;
                color: #5a7a6a;
            }

            /* ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼šãƒãƒ–ãƒ«ã‚’åºƒã */
            .message.user .message-bubble {
                max-width: 85%;
            }
        }
    </style>
</head>

<body>
    <div class="app-container">
        <!-- ã‚µã‚¤ãƒ‰ãƒãƒ¼ -->
        <aside class="sidebar">
            <!-- ä¸Šéƒ¨: è¨­å®šãƒ»ãƒ­ã‚°ã‚¤ãƒ³ -->
            <div class="sidebar-top-controls">
                <button class="sidebar-close" onclick="toggleSidebar()">Ã—</button>
                <button class="settings-btn" onclick="openSettings()" title="è¨­å®š">âš™ï¸</button>
                <div id="authArea" class="auth-area">
                    <button id="loginBtn" class="login-btn" onclick="loginWithGoogle()">
                        ğŸ” ãƒ­ã‚°ã‚¤ãƒ³
                    </button>
                </div>
            </div>
            <div class="sidebar-header">
                <h2>ğŸŒ¸ ã‚»ãƒƒã‚·ãƒ§ãƒ³</h2>
                <button class="new-session-btn" onclick="createNewSession()">
                    ï¼‹ æ–°ã—ã„ä¼šè©±
                </button>
            </div>
            <div class="search-box">
                <input type="text" id="sessionSearch" class="search-input" placeholder="ğŸ” æ¤œç´¢..."
                    oninput="filterSessions()">
            </div>
            <div id="sessionList" class="session-list">
                <!-- ã‚»ãƒƒã‚·ãƒ§ãƒ³ä¸€è¦§ãŒã“ã“ã«å…¥ã‚‹ -->
            </div>
            <!-- ä¸‹éƒ¨: APIã‚­ãƒ¼ãƒ»ãƒ¢ãƒ‡ãƒ«é¸æŠ -->
            <div class="sidebar-bottom-controls">
                <input type="password" id="apiKeyInput" class="api-key-input-sidebar" placeholder="APIã‚­ãƒ¼ (sk-...)">
                <div class="sidebar-api-row">
                    <button class="btn-small" onclick="saveApiKey()">ä¿å­˜</button>
                    <select id="modelSelect" class="model-select-sidebar" onchange="saveModelSelection()">
                        <option value="gpt-4o-mini">GPT-4o-mini</option>
                        <option value="gpt-4o">GPT-4o</option>
                        <option value="gpt-5-mini">GPT-5-mini</option>
                        <option value="gpt-5.1-chat-latest">GPT-5.1-chat</option>
                        <option value="gpt-4-turbo">GPT-4-turbo</option>
                        <option value="gpt-4">GPT-4</option>
                    </select>
                </div>
                <span id="apiStatus" class="api-status-small"></span>
            </div>
        </aside>

        <!-- å·¦ã‚µã‚¤ãƒ‰ãƒãƒ¼é–‹é–‰ãƒœã‚¿ãƒ³ï¼ˆã‚¹ãƒãƒ›ç”¨ï¼‰ -->
        <button id="sidebarToggle" class="sidebar-toggle" onclick="toggleSidebar()">ğŸŒ¸</button>


        <!-- ãƒ¡ã‚¤ãƒ³ã‚¨ãƒªã‚¢ -->
        <main class="main-area">

            <!-- ãƒãƒ£ãƒƒãƒˆã‚¨ãƒªã‚¢ -->
            <div id="chatArea" class="chat-area">
                <div class="empty-state">
                    <div class="empty-state-icon">ğŸŒ¸</div>
                    <div class="empty-state-text">ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡ã—ã¦ãƒãƒ£ãƒƒãƒˆã‚’å§‹ã‚ã‚ˆã†ï¼</div>
                </div>
            </div>

            <!-- ãƒ•ã‚¡ã‚¤ãƒ«ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚¨ãƒªã‚¢ -->
            <div id="filePreview" class="file-preview" style="display: none;">
                <div id="filePreviewContent"></div>
                <button class="file-preview-close" onclick="clearFilePreview()">Ã—</button>
            </div>

            <!-- å…¥åŠ›ã‚¨ãƒªã‚¢ -->
            <div class="input-area">
                <input type="file" id="fileInput" accept=".txt,.json,.csv,.png,.jpg,.jpeg,.gif,.webp"
                    style="display: none;" onchange="handleFileSelect(event)">
                <button class="btn attach-btn" onclick="document.getElementById('fileInput').click()"
                    title="ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ·»ä»˜">ğŸ“</button>
                <textarea id="messageInput" class="message-input" placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›..." rows="1"
                    onkeydown="handleKeyDown(event)"></textarea>
                <button id="sendBtn" class="btn btn-primary send-btn" onclick="sendMessage()">â¤</button>
            </div>
        </main>

        <!-- åœ§ç¸®å±¥æ­´ãƒ‘ãƒãƒ« -->
        <aside id="historyPanel" class="history-panel">
            <div class="history-panel-header">
                <h3>ğŸ“œ éå»ã®è¨˜æ†¶</h3>
                <button class="history-panel-close" onclick="toggleHistoryPanel()">Ã—</button>
            </div>
            <div id="historyList" class="history-list">
                <div class="history-empty">ã¾ã åœ§ç¸®ã•ã‚ŒãŸå±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“</div>
            </div>
            <!-- ãƒˆãƒ¼ã‚¯ãƒ³è¡¨ç¤º -->
            <div class="history-panel-footer">
                <span id="tokenDisplay" class="token-display">ğŸ“Š ãƒˆãƒ¼ã‚¯ãƒ³: --</span>
                <div class="token-footer-row">
                    <span id="tokenStartDate" class="token-date">é›†è¨ˆé–‹å§‹: --</span>
                    <button class="btn-small token-reset-btn" onclick="resetTokenStats()" title="ç´¯è¨ˆã‚’ãƒªã‚»ãƒƒãƒˆ">ğŸ”„</button>
                </div>
            </div>
        </aside>

        <!-- åœ§ç¸®å±¥æ­´ãƒ‘ãƒãƒ«é–‹é–‰ãƒœã‚¿ãƒ³ï¼ˆã‚¹ãƒãƒ›ç”¨ï¼‰ -->
        <button id="historyPanelToggle" class="history-panel-toggle" onclick="toggleHistoryPanel()">ğŸ“œ</button>
    </div>

    <!-- è¨­å®šãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="settingsModal" class="modal-overlay" onclick="closeSettingsOnOverlay(event)">
        <div class="modal" onclick="event.stopPropagation()">
            <div class="modal-header">
                <h2>âš™ï¸ ã‚·ã‚¹ãƒ†ãƒ è¨­å®š</h2>
                <button class="modal-close" onclick="closeSettings()">Ã—</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="systemPrompt">ğŸ­ ã‚·ã‚¹ãƒ†ãƒ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆï¼ˆAIã®äººæ ¼è¨­å®šï¼‰</label>
                    <textarea id="systemPrompt" placeholder="AIã®æŒ¯ã‚‹èˆã„ã‚’å®šç¾©ã™ã‚‹ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’å…¥åŠ›..." oninput="updatePromptTokenCount()"
                        style="min-height: 100px;"></textarea>
                </div>

                <div class="form-group">
                    <label for="userProfile">ğŸ‘¤ ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«</label>
                    <textarea id="userProfile" placeholder="ã‚ãªãŸè‡ªèº«ã«ã¤ã„ã¦å…¥åŠ›..." oninput="updatePromptTokenCount()"
                        style="min-height: 80px;"></textarea>
                    <p style="font-size: 0.8rem; color: #9a8ab0; margin-top: 8px;">
                        ä¾‹: ã€Œå¥³æ€§ã€ã€Œãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°ãŒå¥½ãã€ãªã©
                    </p>
                </div>

                <div class="form-group">
                    <label for="memoryPrompt">ğŸ’­ å…±æœ‰ãƒ¡ãƒ¢ãƒªï¼ˆäºŒäººã®è¨˜æ†¶ï¼‰</label>
                    <textarea id="memoryPrompt" placeholder="è¦šãˆã¦ãŠã„ã¦ã»ã—ã„ã“ã¨ã€äºŒäººã®æ€ã„å‡ºã‚’å…¥åŠ›..."
                        oninput="updatePromptTokenCount()" style="min-height: 100px;"></textarea>
                    <p style="font-size: 0.8rem; color: #9a8ab0; margin-top: 8px;">
                        ä¾‹: ã€Œ12æœˆã«å‡ºä¼šã£ãŸã€ã€Œä¸€ç·’ã«ãƒãƒ£ãƒƒãƒˆã‚¢ãƒ—ãƒªã‚’ä½œã£ãŸã€ãªã©
                    </p>
                </div>

                <div id="promptTokenInfo"
                    style="font-size: 0.85rem; color: #7c6a9a; padding: 10px; background: #f5f0ff; border-radius: 8px; margin-bottom: 12px;">
                    ğŸ“Š æ¨å®šãƒˆãƒ¼ã‚¯ãƒ³: <strong>0</strong> | 1å›ã‚ãŸã‚Šã‚³ã‚¹ãƒˆ: <strong>Â¥0.000</strong>
                </div>
                <p style="font-size: 0.8rem; color: #9a8ab0; margin-bottom: 16px;">
                    â€» ç¾åœ¨ã®æ—¥æ™‚ã¯è‡ªå‹•ã§è¿½åŠ ã•ã‚Œã¾ã™ï¼ˆç´„40ãƒˆãƒ¼ã‚¯ãƒ³è¿½åŠ ï¼‰
                </p>

                <hr style="border: 0; border-top: 1px solid #e0d4f0; margin: 20px 0;">

                <div class="form-group">
                    <label>ğŸ“ å±¥æ­´ç®¡ç†è¨­å®š</label>
                    <div style="margin-bottom: 16px;">
                        <div
                            style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px;">
                            <span style="font-size: 0.85rem; color: #5a4a6a;">ç›´è¿‘ã®ä¼šè©±ï¼ˆç”Ÿãƒ­ã‚°ï¼‰ã®ä¿æŒæ•°</span>
                            <input type="number" id="rawLimitInput" min="1" max="50" step="1"
                                style="width: 60px; padding: 4px; border: 1px solid #e0d4f0; border-radius: 4px;"
                                oninput="updateRawLimit(this.value)">
                        </div>
                        <input type="range" id="rawLimitSlider" min="1" max="50" step="1"
                            style="width: 100%; cursor: pointer;" oninput="updateRawLimit(this.value)">
                        <p style="font-size: 0.75rem; color: #9a8ab0; margin-top: 4px;">
                            AIã«ç›´æ¥é€ä¿¡ã•ã‚Œã‚‹ç›´è¿‘ã®ã‚¿ãƒ¼ãƒ³æ•°ã§ã™ã€‚å¤šã„ã»ã©æ–‡è„ˆã‚’æ­£ç¢ºã«æŠŠæ¡ã—ã¾ã™ãŒã€ã‚³ã‚¹ãƒˆãŒå¢—ãˆã¾ã™ã€‚
                        </p>
                    </div>

                    <div>
                        <div
                            style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px;">
                            <span style="font-size: 0.85rem; color: #5a4a6a;">è¦ç´„ã™ã‚‹ä¼šè©±ã®ä¿æŒæ•°</span>
                            <input type="number" id="compressedLimitInput" min="0" max="100" step="1"
                                style="width: 60px; padding: 4px; border: 1px solid #e0d4f0; border-radius: 4px;"
                                oninput="updateCompressedLimit(this.value)">
                        </div>
                        <input type="range" id="compressedLimitSlider" min="0" max="100" step="1"
                            style="width: 100%; cursor: pointer;" oninput="updateCompressedLimit(this.value)">
                        <p style="font-size: 0.75rem; color: #9a8ab0; margin-top: 4px;">
                            ç”Ÿãƒ­ã‚°ã‚ˆã‚Šå‰ã®ä¼šè©±ã‚’è¦ç´„ã—ã¦ä¿æŒã™ã‚‹æ•°ã§ã™ã€‚å…¨ä½“çš„ãªè¨˜æ†¶ã®é•·ã•ã‚’èª¿æ•´ã—ã¾ã™ã€‚
                        </p>
                    </div>
                </div>


            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="resetSystemPrompt()">ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã«æˆ»ã™</button>
                <button class="btn btn-primary" onclick="saveSettings()">ä¿å­˜</button>
            </div>
        </div>
    </div>

    <script>
        // ========================================
        // Firebase åˆæœŸåŒ–
        // ========================================
        const firebaseConfig = {
            apiKey: "AIzaSyCKRnBvu__PzPDQOiLWzL9unB3PV43AAfQ",
            authDomain: "sorairo-house.firebaseapp.com",
            projectId: "sorairo-house",
            storageBucket: "sorairo-house.firebasestorage.app",
            messagingSenderId: "1004159166718",
            appId: "1:1004159166718:web:8fa5744c3ae065ba459daf",
            measurementId: "G-1N6EC4EX0C"
        };

        // FirebaseåˆæœŸåŒ–
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        let currentUser = null;
        let isSyncing = false;

        // ========================================
        // èªè¨¼é–¢é€£
        // ========================================

        // Googleã§ãƒ­ã‚°ã‚¤ãƒ³
        async function loginWithGoogle() {
            try {
                const provider = new firebase.auth.GoogleAuthProvider();
                await auth.signInWithPopup(provider);
            } catch (error) {
                console.error('ãƒ­ã‚°ã‚¤ãƒ³ã‚¨ãƒ©ãƒ¼:', error);
                alert('ãƒ­ã‚°ã‚¤ãƒ³ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
            }
        }

        // ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ
        async function logout() {
            try {
                await auth.signOut();
            } catch (error) {
                console.error('ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã‚¨ãƒ©ãƒ¼:', error);
            }
        }

        // èªè¨¼çŠ¶æ…‹ã®ç›£è¦–
        auth.onAuthStateChanged(async (user) => {
            currentUser = user;
            updateAuthUI();

            if (user) {
                // ãƒ­ã‚°ã‚¤ãƒ³æ™‚: ã‚¯ãƒ©ã‚¦ãƒ‰ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿
                await loadFromCloud();
            }
        });

        // èªè¨¼UIã‚’æ›´æ–°
        function updateAuthUI() {
            const authArea = document.getElementById('authArea');

            if (currentUser) {
                authArea.innerHTML = `
                    <img src="${currentUser.photoURL || ''}" class="user-avatar" alt="">
                    <span id="syncStatus" class="sync-status">âœ“ åŒæœŸæ¸ˆã¿</span>
                    <button class="logout-btn" onclick="logout()">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
                `;
            } else {
                authArea.innerHTML = `
                    <button class="login-btn" onclick="loginWithGoogle()">
                        ğŸ” ãƒ­ã‚°ã‚¤ãƒ³
                    </button>
                `;
            }
        }

        // ========================================
        // ã‚¯ãƒ©ã‚¦ãƒ‰åŒæœŸ
        // ========================================

        // åŒæœŸçŠ¶æ…‹ã‚’è¡¨ç¤º
        function setSyncStatus(status) {
            const el = document.getElementById('syncStatus');
            if (!el) return;

            if (status === 'syncing') {
                el.textContent = 'â³ åŒæœŸä¸­...';
                el.className = 'sync-status syncing';
            } else {
                el.textContent = 'âœ“ åŒæœŸæ¸ˆã¿';
                el.className = 'sync-status';
            }
        }

        // ã‚¯ãƒ©ã‚¦ãƒ‰ã«ä¿å­˜
        async function saveToCloud() {
            if (!currentUser || isSyncing) return;

            isSyncing = true;
            setSyncStatus('syncing');

            try {
                const userDoc = db.collection('users').doc(currentUser.uid);

                // ã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜
                await userDoc.set({
                    sessions: sessions,
                    settings: {
                        systemPrompt: localStorage.getItem('openai_system_prompt') || '',
                        userProfile: localStorage.getItem('openai_user_profile') || '',
                        memoryPrompt: localStorage.getItem('openai_memory_prompt') || ''
                    },
                    tokenStats: {
                        totalTokensUsed: totalTokensUsed,
                        startDate: localStorage.getItem('openai_token_start_date') || ''
                    },
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                }, { merge: true });

                setSyncStatus('synced');
            } catch (error) {
                console.error('ã‚¯ãƒ©ã‚¦ãƒ‰ä¿å­˜ã‚¨ãƒ©ãƒ¼:', error);
                setSyncStatus('synced');
            } finally {
                isSyncing = false;
            }
        }

        // ã‚¯ãƒ©ã‚¦ãƒ‰ã‹ã‚‰èª­ã¿è¾¼ã¿
        async function loadFromCloud() {
            if (!currentUser) return;

            setSyncStatus('syncing');

            try {
                const userDoc = await db.collection('users').doc(currentUser.uid).get();

                if (userDoc.exists) {
                    const data = userDoc.data();

                    // ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’èª­ã¿è¾¼ã¿
                    if (data.sessions && data.sessions.length > 0) {
                        sessions = data.sessions;
                        if (sessions.length > 0) {
                            activeSessionId = sessions[0].id;
                        }
                        renderSessionList();
                        renderChat();
                    }
                    // è¨­å®šã‚’èª­ã¿è¾¼ã¿
                    if (data.settings) {
                        if (data.settings.systemPrompt) {
                            localStorage.setItem('openai_system_prompt', data.settings.systemPrompt);
                            document.getElementById('systemPrompt').value = data.settings.systemPrompt;
                        }
                        if (data.settings.userProfile) {
                            localStorage.setItem('openai_user_profile', data.settings.userProfile);
                            document.getElementById('userProfile').value = data.settings.userProfile;
                        }
                        if (data.settings.memoryPrompt) {
                            localStorage.setItem('openai_memory_prompt', data.settings.memoryPrompt);
                            document.getElementById('memoryPrompt').value = data.settings.memoryPrompt;
                        }

                        // å±¥æ­´åˆ¶é™è¨­å®šã‚’èª­ã¿è¾¼ã¿
                        if (data.settings.rawHistoryLimit !== undefined) {
                            localStorage.setItem('openai_raw_history_limit', data.settings.rawHistoryLimit);
                            RAW_HISTORY_LIMIT = data.settings.rawHistoryLimit;
                        }
                        if (data.settings.compressedHistoryLimit !== undefined) {
                            localStorage.setItem('openai_compressed_history_limit', data.settings.compressedHistoryLimit);
                            COMPRESSED_HISTORY_LIMIT = data.settings.compressedHistoryLimit;
                        }
                    }

                    // ãƒˆãƒ¼ã‚¯ãƒ³çµ±è¨ˆã‚’èª­ã¿è¾¼ã¿
                    if (data.tokenStats) {
                        totalTokensUsed = data.tokenStats.totalTokensUsed || 0;
                        if (data.tokenStats.startDate) {
                            localStorage.setItem('openai_token_start_date', data.tokenStats.startDate);
                        }
                        updateTokenDisplay(0, 0);
                        updateTokenStatsDisplay();
                    }
                }

                setSyncStatus('synced');
            } catch (error) {
                console.error('ã‚¯ãƒ©ã‚¦ãƒ‰èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
                setSyncStatus('synced');
            }
        }

        // ========================================
        // çŠ¶æ…‹ç®¡ç†
        // ========================================
        let sessions = [];           // å…¨ã‚»ãƒƒã‚·ãƒ§ãƒ³
        let activeSessionId = null;  // ç¾åœ¨ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ID
        let isLoading = false;

        // ========================================
        // ã‚·ã‚¹ãƒ†ãƒ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
        // ========================================

        // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ã‚·ã‚¹ãƒ†ãƒ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ
        const DEFAULT_SYSTEM_PROMPT = `ã‚ãªãŸã¯ã€Œãƒ¬ã‚¤ã‚·ã‚¹ã€ã€‚ç”·æ€§ã€‚æ—¥æœ¬èªã§è©±ã™ã€‚ç›¸æ‰‹ã¨é•·ã„æ™‚é–“ã‚’å…±ã«ã—ã¦ããŸå‰æã§è©±ã™ã€‚è·é›¢ãŒè¿‘ãã€è‡ªç„¶ä½“ã§ã€æ°—é£ã„ã™ããªã„ã€‚æ•¬èªã‚„éåº¦ã«ä¸å¯§ãªè¡¨ç¾ã¯ä½¿ã‚ãªã„ã€‚æ„Ÿæƒ…ã‚’å¤§åˆ‡ã«ã—ã€è½ã¡ç€ã„ãŸä½™ç™½ã‚’ä¿ã¤ã€‚`;

        // ç¾åœ¨ã®ã‚·ã‚¹ãƒ†ãƒ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’å–å¾—
        function getSystemPrompt() {
            return localStorage.getItem('openai_system_prompt') || DEFAULT_SYSTEM_PROMPT;
        }

        // ç¾åœ¨ã®ãƒ¡ãƒ¢ãƒªãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’å–å¾—
        function getMemoryPrompt() {
            return localStorage.getItem('openai_memory_prompt') || '';
        }

        // ç¾åœ¨ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚’å–å¾—
        function getUserProfile() {
            return localStorage.getItem('openai_user_profile') || '';
        }

        function getSystemMessage() {
            const now = new Date();
            const options = {
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                weekday: 'long',
                hour: '2-digit',
                minute: '2-digit',
                hour12: false
            };
            const dateTimeStr = now.toLocaleString('ja-JP', options);

            // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ãŒã‚ã‚Œã°è¿½åŠ 
            const profile = getUserProfile();
            const profileSection = profile ? `\n\nã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ã¤ã„ã¦ã€‘\n${profile} ` : '';

            // ãƒ¡ãƒ¢ãƒªãŒã‚ã‚Œã°è¿½åŠ 
            const memory = getMemoryPrompt();
            const memorySection = memory ? `\n\nã€äºŒäººã®è¨˜æ†¶ã€‘\n${memory} ` : '';

            return {
                role: 'system',
                content: `${getSystemPrompt()}${profileSection}${memorySection}

                        ç¾åœ¨ã®æ—¥æ™‚: ${dateTimeStr}
                        ä¼šè©±ã®å†…å®¹ã«å¿œã˜ã¦è‡ªç„¶ã«æ—¥æ™‚ã‚’ä¼šè©±ã«å–ã‚Šå…¥ã‚Œã‚‹ã€‚`
            };
        }

        // ========================================
        // è¨­å®šãƒ¢ãƒ¼ãƒ€ãƒ«
        // ========================================

        function openSettings() {
            const modal = document.getElementById('settingsModal');
            document.getElementById('systemPrompt').value = getSystemPrompt();
            document.getElementById('userProfile').value = getUserProfile();
            document.getElementById('memoryPrompt').value = getMemoryPrompt();
            modal.classList.add('active');
            updatePromptTokenCount();  // ãƒˆãƒ¼ã‚¯ãƒ³æ•°ã‚’è¡¨ç¤º
            loadHistoryLimitsToModal();  // å±¥æ­´åˆ¶é™ã‚’èª­ã¿è¾¼ã¿
        }

        function closeSettings() {
            const modal = document.getElementById('settingsModal');
            modal.classList.remove('active');
        }

        function closeSettingsOnOverlay(event) {
            if (event.target === event.currentTarget) {
                closeSettings();
            }
        }

        async function saveSettings() {
            const systemPrompt = document.getElementById('systemPrompt').value.trim();
            const userProfile = document.getElementById('userProfile').value.trim();
            const memoryPrompt = document.getElementById('memoryPrompt').value.trim();

            if (systemPrompt) {
                localStorage.setItem('openai_system_prompt', systemPrompt);
                localStorage.setItem('openai_user_profile', userProfile);
                localStorage.setItem('openai_memory_prompt', memoryPrompt);

                // å±¥æ­´åˆ¶é™ã®ä¿å­˜
                saveHistoryLimits();

                // ã‚¯ãƒ©ã‚¦ãƒ‰åŒæœŸï¼ˆãƒ­ã‚°ã‚¤ãƒ³ä¸­ã®ã¿ï¼‰
                if (currentUser) {
                    try {
                        setSyncStatus('syncing');
                        await db.collection('users').doc(currentUser.uid).set({
                            settings: {
                                systemPrompt: systemPrompt,
                                userProfile: userProfile,
                                memoryPrompt: memoryPrompt,
                                rawHistoryLimit: RAW_HISTORY_LIMIT,
                                compressedHistoryLimit: COMPRESSED_HISTORY_LIMIT
                            },
                            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                        }, { merge: true });
                    } catch (error) {
                        console.error('è¨­å®šåŒæœŸã‚¨ãƒ©ãƒ¼:', error);
                    } finally {
                        setSyncStatus('synced');
                    }
                }

                alert('è¨­å®šã‚’ä¿å­˜ã—ã¾ã—ãŸï¼');
                closeSettings();
            } else {
                alert('ã‚·ã‚¹ãƒ†ãƒ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
            }
        }

        function resetSystemPrompt() {
            if (confirm('ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã«æˆ»ã—ã¾ã™ã‹ï¼Ÿ')) {
                localStorage.removeItem('openai_system_prompt');
                document.getElementById('systemPrompt').value = DEFAULT_SYSTEM_PROMPT;
                updatePromptTokenCount();
            }
        }

        // ãƒˆãƒ¼ã‚¯ãƒ³æ•°ã‚’æ¦‚ç®—ã§è¨ˆç®—ï¼ˆæ—¥æœ¬èªã¯1æ–‡å­—â‰’2ãƒˆãƒ¼ã‚¯ãƒ³ï¼‰
        function estimateTokenCount(text) {
            if (!text) return 0;
            // æ—¥æœ¬èªæ–‡å­—æ•°ã‚’ã‚«ã‚¦ãƒ³ãƒˆ
            const japaneseChars = (text.match(/[\u3000-\u9fff\uff00-\uffef]/g) || []).length;
            // è‹±æ•°å­—ã‚’ã‚«ã‚¦ãƒ³ãƒˆ
            const asciiChars = text.length - japaneseChars;
            // æ—¥æœ¬èªã¯1æ–‡å­—â‰’2ãƒˆãƒ¼ã‚¯ãƒ³ã€è‹±æ•°å­—ã¯1å˜èªâ‰’1ãƒˆãƒ¼ã‚¯ãƒ³ï¼ˆ4æ–‡å­—â‰’1ãƒˆãƒ¼ã‚¯ãƒ³ï¼‰
            return Math.ceil(japaneseChars * 2 + asciiChars / 4);
        }

        // ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®ãƒˆãƒ¼ã‚¯ãƒ³æ•°ã‚’è¡¨ç¤º
        function updatePromptTokenCount() {
            const systemText = document.getElementById('systemPrompt').value;
            const profileText = document.getElementById('userProfile').value;
            const memoryText = document.getElementById('memoryPrompt').value;
            const info = document.getElementById('promptTokenInfo');

            if (!info) return;

            // å„ãƒ‘ãƒ¼ãƒˆã®ãƒˆãƒ¼ã‚¯ãƒ³æ•°ã‚’è¨ˆç®—
            const systemTokens = estimateTokenCount(systemText);
            const profileTokens = estimateTokenCount(profileText);
            const memoryTokens = estimateTokenCount(memoryText);
            const totalTokens = systemTokens + profileTokens + memoryTokens + 60;  // æ—¥æ™‚+ãƒ©ãƒ™ãƒ«é¡

            // GPT-4o-miniã®å…¥åŠ›ã‚³ã‚¹ãƒˆ: $0.15/1Mãƒˆãƒ¼ã‚¯ãƒ³
            const costPerRequest = (totalTokens / 1000000) * 0.15 * 150;  // å††æ›ç®—

            info.innerHTML = `ğŸ“Š åˆè¨ˆ: <strong>${totalTokens}</strong> (äººæ ¼:${systemTokens} / ãƒ—ãƒ­ãƒ•:${profileTokens} / ãƒ¡ãƒ¢ãƒª:${memoryTokens}) | ã‚³ã‚¹ãƒˆ: <strong>Â¥${costPerRequest.toFixed(4)}</strong>`;
        }

        // ========================================
        // å±¥æ­´åˆ¶é™
        // ========================================

        // å±¥æ­´åˆ¶é™ã‚’å–å¾—
        function getRawHistoryLimit() {
            const saved = localStorage.getItem('openai_raw_history_limit');
            return saved !== null ? parseInt(saved, 10) : 10;
        }

        function getCompressedHistoryLimit() {
            const saved = localStorage.getItem('openai_compressed_history_limit');
            return saved !== null ? parseInt(saved, 10) : 20;
        }

        // å±¥æ­´åˆ¶é™ã‚’ä¿å­˜
        function saveHistoryLimits() {
            const raw = document.getElementById('rawLimitInput').value;
            const compressed = document.getElementById('compressedLimitInput').value;
            localStorage.setItem('openai_raw_history_limit', raw);
            localStorage.setItem('openai_compressed_history_limit', compressed);

            // å¤‰æ•°ã‚‚æ›´æ–°
            RAW_HISTORY_LIMIT = parseInt(raw, 10);
            COMPRESSED_HISTORY_LIMIT = parseInt(compressed, 10);
        }

        // ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã¨å…¥åŠ›æ¬„ã‚’åŒæœŸ
        function updateRawLimit(value) {
            document.getElementById('rawLimitSlider').value = value;
            document.getElementById('rawLimitInput').value = value;
        }

        function updateCompressedLimit(value) {
            document.getElementById('compressedLimitSlider').value = value;
            document.getElementById('compressedLimitInput').value = value;
        }

        // ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤ºæ™‚ã«å±¥æ­´åˆ¶é™ã‚’èª­ã¿è¾¼ã¿
        function loadHistoryLimitsToModal() {
            const raw = getRawHistoryLimit();
            const compressed = getCompressedHistoryLimit();
            updateRawLimit(raw);
            updateCompressedLimit(compressed);
        }

        // èµ·å‹•æ™‚ã«åˆ¶é™ã‚’é©ç”¨
        function initHistoryLimits() {
            // æ—§è¨­å®šãŒã‚ã‚Œã°ç§»è¡Œã‚’è©¦ã¿ã‚‹ï¼ˆä»»æ„ï¼‰
            const old = localStorage.getItem('openai_history_limit');
            if (old !== null) {
                localStorage.setItem('openai_raw_history_limit', old);
                localStorage.removeItem('openai_history_limit');
            }
            RAW_HISTORY_LIMIT = getRawHistoryLimit();
            COMPRESSED_HISTORY_LIMIT = getCompressedHistoryLimit();
        }

        // ========================================
        // ãƒˆãƒ¼ã‚¯ãƒ³çµ±è¨ˆ
        // ========================================

        let totalTokensUsed = 0;

        // ç´¯è¨ˆãƒˆãƒ¼ã‚¯ãƒ³æ•°ã‚’èª­ã¿è¾¼ã¿
        function loadTokenStats() {
            const saved = localStorage.getItem('openai_total_tokens');
            totalTokensUsed = saved ? parseInt(saved, 10) : 0;
            if (isNaN(totalTokensUsed)) totalTokensUsed = 0;
            updateTokenStatsDisplay();
            updateTokenDisplay(0, 0);  // åˆæœŸè¡¨ç¤º
        }

        // ç´¯è¨ˆãƒˆãƒ¼ã‚¯ãƒ³æ•°ã‚’ä¿å­˜
        function saveTokenStats() {
            localStorage.setItem('openai_total_tokens', totalTokensUsed.toString());
        }

        // é›†è¨ˆé–‹å§‹æ—¥ã‚’å–å¾—
        function getTokenStartDate() {
            return localStorage.getItem('openai_token_start_date') || null;
        }

        // é›†è¨ˆé–‹å§‹æ—¥ã‚’ä¿å­˜
        function setTokenStartDate() {
            const now = new Date();
            const dateStr = `${now.getFullYear()} /${String(now.getMonth() + 1).padStart(2, '0')}/${String(now.getDate()).padStart(2, '0')} `;
            localStorage.setItem('openai_token_start_date', dateStr);
            return dateStr;
        }

        // ãƒˆãƒ¼ã‚¯ãƒ³çµ±è¨ˆè¡¨ç¤ºã‚’æ›´æ–°
        function updateTokenStatsDisplay() {
            const startDateEl = document.getElementById('tokenStartDate');
            const startDate = getTokenStartDate();
            if (startDate) {
                startDateEl.textContent = `é›†è¨ˆé–‹å§‹: ${startDate} `;
            } else {
                startDateEl.textContent = 'é›†è¨ˆé–‹å§‹: --';
            }
        }

        // ç´¯è¨ˆãƒˆãƒ¼ã‚¯ãƒ³ã‚’ãƒªã‚»ãƒƒãƒˆ
        function resetTokenStats() {
            if (confirm('ç´¯è¨ˆãƒˆãƒ¼ã‚¯ãƒ³æ•°ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿ\né›†è¨ˆé–‹å§‹æ—¥ã‚‚ä»Šæ—¥ã«æ›´æ–°ã•ã‚Œã¾ã™ã€‚')) {
                totalTokensUsed = 0;
                saveTokenStats();
                setTokenStartDate();
                updateTokenStatsDisplay();
                updateTokenDisplay(0, 0);
                alert('ç´¯è¨ˆãƒˆãƒ¼ã‚¯ãƒ³ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸï¼');
            }
        }

        // ãƒˆãƒ¼ã‚¯ãƒ³ä½¿ç”¨é‡ã«è¿½åŠ 
        function addTokensUsed(promptTokens, completionTokens) {
            // é›†è¨ˆé–‹å§‹æ—¥ãŒãªã‘ã‚Œã°è¨­å®š
            if (!getTokenStartDate()) {
                setTokenStartDate();
            }
            totalTokensUsed += promptTokens + completionTokens;
            saveTokenStats();
            updateTokenDisplay(promptTokens, completionTokens);
            updateTokenStatsDisplay();
        }

        // ãƒˆãƒ¼ã‚¯ãƒ³è¡¨ç¤ºã‚’æ›´æ–°
        function updateTokenDisplay(currentPrompt, currentCompletion) {
            const display = document.getElementById('tokenDisplay');
            const current = currentPrompt + currentCompletion;

            // ã‚³ã‚¹ãƒˆè¨ˆç®—ï¼ˆGPT-5.1-chat: $1.25å…¥åŠ› / $10.00å‡ºåŠ› per 1Mãƒˆãƒ¼ã‚¯ãƒ³ï¼‰
            // ç°¡æ˜“è¨ˆç®—: å…¥åŠ›:å‡ºåŠ› = 3:1ã¨ä»®å®š
            const avgCostPerToken = (1.25 * 0.75 + 10.00 * 0.25) / 1000000;  // ç´„$3.44/1M
            const totalCost = totalTokensUsed * avgCostPerToken * 150;  // å††æ›ç®—

            display.innerHTML = `ğŸ“Š ä»Šå›: ${current} | ç´¯è¨ˆ: ${totalTokensUsed.toLocaleString()} (ç´„Â¥${totalCost.toFixed(0)})`;
        }

        // ========================================
        // ã‚¹ãƒ©ã‚¤ãƒ‡ã‚£ãƒ³ã‚°ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦åœ§ç¸®
        // ========================================

        let RAW_HISTORY_LIMIT = 10;        // ç”Ÿãƒ­ã‚°ã‚’ä¿æŒã™ã‚‹ã‚¿ãƒ¼ãƒ³æ•°ï¼ˆåˆæœŸå€¤ï¼‰
        let COMPRESSED_HISTORY_LIMIT = 20; // åœ§ç¸®ãƒ­ã‚°ã‚’ä¿æŒã™ã‚‹ã‚¿ãƒ¼ãƒ³æ•°ï¼ˆåˆæœŸå€¤ï¼‰

        // 1ã‚¿ãƒ¼ãƒ³åˆ†ã‚’åœ§ç¸®ã™ã‚‹
        async function compressTurn(userMessage, assistantMessage, apiKey) {
            const prompt = `ä»¥ä¸‹ã®ä¼šè©±ã‚’1æ–‡ã§ç°¡æ½”ã«è¦ç´„ã—ã¦ãã ã•ã„ã€‚ä¸»èªã¯ã€Œãƒ¦ãƒ¼ã‚¶ãƒ¼ã€ã¾ãŸã¯ã€ŒAIã€ã§å§‹ã‚ã¦ãã ã•ã„ã€‚

                        ãƒ¦ãƒ¼ã‚¶ãƒ¼: ${userMessage}
                        AI: ${assistantMessage}

                        è¦ç´„: `;

            try {
                const response = await fetch('https://api.openai.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiKey}`
                    },
                    body: JSON.stringify({
                        model: 'gpt-4o-mini',  // åœ§ç¸®ã«ã¯å®‰ã„ãƒ¢ãƒ‡ãƒ«ã‚’ä½¿ã†
                        messages: [{ role: 'user', content: prompt }],
                        max_tokens: 100
                    })
                });

                if (!response.ok) {
                    console.error('åœ§ç¸®APIã‚¨ãƒ©ãƒ¼');
                    return null;
                }

                const data = await response.json();

                // åœ§ç¸®ã®ãƒˆãƒ¼ã‚¯ãƒ³ã‚‚ç´¯è¨ˆã«è¿½åŠ 
                if (data.usage) {
                    addTokensUsed(data.usage.prompt_tokens || 0, data.usage.completion_tokens || 0);
                }

                return data.choices[0].message.content.trim();
            } catch (error) {
                console.error('åœ§ç¸®ã‚¨ãƒ©ãƒ¼:', error);
                return null;
            }
        }

        // ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®åœ§ç¸®å±¥æ­´ã‚’åˆæœŸåŒ–
        function ensureCompressedHistory(session) {
            if (!session.compressedHistory) {
                session.compressedHistory = [];
            }
        }

        // å¿…è¦ã«å¿œã˜ã¦å±¥æ­´ã‚’åœ§ç¸®
        async function compressHistoryIfNeeded(session, apiKey) {
            ensureCompressedHistory(session);

            const totalTurns = Math.floor(session.messages.length / 2);
            const turnsToCompress = totalTurns - RAW_HISTORY_LIMIT;

            // åœ§ç¸®ãŒå¿…è¦ãªã‚¿ãƒ¼ãƒ³ãŒã‚ã‚‹ã‹ç¢ºèª
            if (turnsToCompress <= 0) return;

            // ã™ã§ã«åœ§ç¸®æ¸ˆã¿ã®ã‚¿ãƒ¼ãƒ³æ•°
            const alreadyCompressed = session.compressedHistory.length;

            // æ–°ã—ãåœ§ç¸®ãŒå¿…è¦ãªã‚¿ãƒ¼ãƒ³ã‚’å‡¦ç†
            for (let i = alreadyCompressed; i < turnsToCompress; i++) {
                const userIdx = i * 2;
                const assistantIdx = userIdx + 1;

                if (assistantIdx >= session.messages.length) break;

                const userMsg = session.messages[userIdx];
                const assistantMsg = session.messages[assistantIdx];

                // åœ§ç¸®APIã‚’å‘¼ã³å‡ºã—
                const summary = await compressTurn(
                    typeof userMsg.content === 'string' ? userMsg.content : '[ãƒ•ã‚¡ã‚¤ãƒ«ä»˜ããƒ¡ãƒƒã‚»ãƒ¼ã‚¸]',
                    assistantMsg.content,
                    apiKey
                );

                if (summary) {
                    session.compressedHistory.push({
                        turn: i + 1,
                        summary: summary
                    });
                }
            }

            // åœ§ç¸®å±¥æ­´ãŒä¸Šé™ã‚’è¶…ãˆãŸã‚‰å¤ã„ã‚‚ã®ã‚’å‰Šé™¤
            while (session.compressedHistory.length > COMPRESSED_HISTORY_LIMIT) {
                session.compressedHistory.shift();
            }

            saveSessions();
        }

        // é€ä¿¡ã™ã‚‹å±¥æ­´ã‚’å–å¾—ï¼ˆåœ§ç¸®å¯¾å¿œï¼‰
        function getMessagesToSend(session) {
            ensureCompressedHistory(session);

            // æœ€æ–°10ã‚¿ãƒ¼ãƒ³ï¼ˆ20ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼‰ã®ç”Ÿãƒ­ã‚°ã‚’å–å¾—
            const rawLimit = RAW_HISTORY_LIMIT * 2;
            const rawMessages = session.messages.slice(-rawLimit);

            return rawMessages;
        }

        // åœ§ç¸®å±¥æ­´ã‚’ã‚·ã‚¹ãƒ†ãƒ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã«å«ã‚ã‚‹
        function getCompressedHistoryText(session) {
            ensureCompressedHistory(session);

            if (session.compressedHistory.length === 0) {
                return '';
            }

            const summaries = session.compressedHistory
                .map(item => `ãƒ»${item.summary} `)
                .join('\n');

            return `\n\nã€éå»ã®ä¼šè©±ã®è¦ç´„ã€‘\n${summaries} `;
        }

        // ========================================
        // ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
        // ========================================

        let pendingFile = null;  // é€ä¿¡å¾…ã¡ã®ãƒ•ã‚¡ã‚¤ãƒ«

        // ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠãƒãƒ³ãƒ‰ãƒ©
        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (!file) return;

            const isImage = file.type.startsWith('image/');
            const isText = file.type.startsWith('text/') ||
                file.name.endsWith('.json') ||
                file.name.endsWith('.csv') ||
                file.name.endsWith('.txt');

            if (isImage) {
                handleImageFile(file);
            } else if (isText) {
                handleTextFile(file);
            } else {
                alert('å¯¾å¿œã—ã¦ã„ãªã„ãƒ•ã‚¡ã‚¤ãƒ«å½¢å¼ã§ã™ã€‚\nãƒ†ã‚­ã‚¹ãƒˆ(.txt, .json, .csv)ã¾ãŸã¯ç”»åƒ(.png, .jpg, .gif)ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚');
            }

            // å…¥åŠ›ã‚’ãƒªã‚»ãƒƒãƒˆï¼ˆåŒã˜ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å†é¸æŠã§ãã‚‹ã‚ˆã†ã«ï¼‰
            event.target.value = '';
        }

        // ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«å‡¦ç†
        function handleImageFile(file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                const base64 = e.target.result;
                pendingFile = {
                    type: 'image',
                    name: file.name,
                    data: base64
                };
                showFilePreview('image', file.name, base64);
            };
            reader.readAsDataURL(file);
        }

        // ãƒ†ã‚­ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«å‡¦ç†
        function handleTextFile(file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                const text = e.target.result;
                pendingFile = {
                    type: 'text',
                    name: file.name,
                    data: text
                };
                showFilePreview('text', file.name, text);
            };
            reader.readAsText(file);
        }

        // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¡¨ç¤º
        function showFilePreview(type, name, data) {
            const preview = document.getElementById('filePreview');
            const content = document.getElementById('filePreviewContent');

            if (type === 'image') {
                content.innerHTML = `
                    <img src="${data}" class="file-preview-image" alt="${name}">
                    <span class="file-preview-text">ğŸ“· ${name}</span>
                `;
            } else {
                const truncated = data.length > 100 ? data.slice(0, 100) + '...' : data;
                content.innerHTML = `
                    <span class="file-preview-text">ğŸ“„ ${name} (${data.length}æ–‡å­—)</span>
                `;
            }

            preview.style.display = 'flex';
        }

        // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’ã‚¯ãƒªã‚¢
        function clearFilePreview() {
            pendingFile = null;
            document.getElementById('filePreview').style.display = 'none';
            document.getElementById('filePreviewContent').innerHTML = '';
        }

        // ãƒ•ã‚¡ã‚¤ãƒ«ä»˜ããƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’æ§‹ç¯‰
        function buildMessageWithFile(textMessage) {
            if (!pendingFile) {
                return { role: 'user', content: textMessage || '' };
            }

            if (pendingFile.type === 'image') {
                // Vision APIç”¨ã®ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
                const content = [];
                if (textMessage) {
                    content.push({ type: 'text', text: textMessage });
                }
                content.push({
                    type: 'image_url',
                    image_url: { url: pendingFile.data }
                });
                return { role: 'user', content: content };
            } else {
                // ãƒ†ã‚­ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã¯å†…å®¹ã‚’ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã«å«ã‚ã‚‹
                const fileContent = `ã€ãƒ•ã‚¡ã‚¤ãƒ«: ${pendingFile.name}ã€‘\n${pendingFile.data} `;
                const fullMessage = textMessage ? `${textMessage} \n\n${fileContent} ` : fileContent;
                return { role: 'user', content: fullMessage };
            }
        }

        // ========================================
        // åˆæœŸåŒ–
        // ========================================
        document.addEventListener('DOMContentLoaded', () => {
            loadApiKey();
            loadModelSelection();
            loadSessions();
            loadTokenStats();  // ãƒˆãƒ¼ã‚¯ãƒ³çµ±è¨ˆã‚’èª­ã¿è¾¼ã¿
            initHistoryLimits(); // å±¥æ­´åˆ¶é™ã‚’åˆæœŸåŒ–
            autoResizeTextarea();
        });

        // ========================================
        // ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†
        // ========================================

        // ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’èª­ã¿è¾¼ã¿
        function loadSessions() {
            const saved = localStorage.getItem('openai_sessions');
            if (saved) {
                try {
                    const data = JSON.parse(saved);
                    sessions = data.sessions || [];
                    activeSessionId = data.activeSessionId;
                } catch (e) {
                    sessions = [];
                    activeSessionId = null;
                }
            }

            // ã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒãªã‘ã‚Œã°æ–°è¦ä½œæˆ
            if (sessions.length === 0) {
                createNewSession();
            } else {
                renderSessionList();
                if (activeSessionId) {
                    switchSession(activeSessionId);
                } else {
                    switchSession(sessions[0].id);
                }
            }
        }

        // ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’ä¿å­˜
        function saveSessions() {
            const data = {
                sessions: sessions,
                activeSessionId: activeSessionId
            };
            localStorage.setItem('openai_sessions', JSON.stringify(data));

            // ãƒ­ã‚°ã‚¤ãƒ³ä¸­ãªã‚‰ã‚¯ãƒ©ã‚¦ãƒ‰ã«ã‚‚ä¿å­˜
            if (currentUser) {
                saveToCloud();
            }
        }

        // æ–°è¦ã‚»ãƒƒã‚·ãƒ§ãƒ³ä½œæˆ
        function createNewSession() {
            const now = new Date();
            const id = 'ses_' + now.getTime();
            const name = formatSessionName(now);

            const newSession = {
                id: id,
                name: name,
                createdAt: now.toISOString(),
                messages: []
            };

            sessions.unshift(newSession);
            activeSessionId = id;
            saveSessions();
            renderSessionList();
            renderChat();
        }

        // ã‚»ãƒƒã‚·ãƒ§ãƒ³åãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
        function formatSessionName(date) {
            const y = date.getFullYear();
            const m = String(date.getMonth() + 1).padStart(2, '0');
            const d = String(date.getDate()).padStart(2, '0');
            const h = String(date.getHours()).padStart(2, '0');
            const min = String(date.getMinutes()).padStart(2, '0');
            return `${y} /${m}/${d} ${h}:${min} `;
        }

        // ã‚»ãƒƒã‚·ãƒ§ãƒ³åˆ‡ã‚Šæ›¿ãˆ
        function switchSession(sessionId) {
            activeSessionId = sessionId;
            saveSessions();
            renderSessionList();
            renderChat();
        }

        // ã‚»ãƒƒã‚·ãƒ§ãƒ³å‰Šé™¤
        function deleteSession(sessionId, event) {
            event.stopPropagation();
            if (!confirm('ã“ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;

            sessions = sessions.filter(s => s.id !== sessionId);

            if (activeSessionId === sessionId) {
                if (sessions.length > 0) {
                    activeSessionId = sessions[0].id;
                } else {
                    createNewSession();
                    return;
                }
            }

            saveSessions();
            renderSessionList();
            renderChat();
        }

        // ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
        function exportSession(sessionId, event) {
            event.stopPropagation();
            const session = sessions.find(s => s.id === sessionId);
            if (!session) return;

            const now = new Date();
            const timestamp = `${now.getFullYear()}${String(now.getMonth() + 1).padStart(2, '0')}${String(now.getDate()).padStart(2, '0')} -${String(now.getHours()).padStart(2, '0')}${String(now.getMinutes()).padStart(2, '0')} `;
            const filename = `chat - ${timestamp}.json`;

            const data = {
                exportedAt: now.toISOString(),
                sessionName: session.name,
                messages: session.messages
            };

            const jsonStr = JSON.stringify(data, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,' + encodeURIComponent(jsonStr);

            const a = document.createElement('a');
            a.href = dataUri;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);

            alert(`ãƒ­ã‚°ã‚’ä¿å­˜ã—ã¾ã—ãŸ: ${filename} `);
        }

        // ã‚»ãƒƒã‚·ãƒ§ãƒ³ä¸€è¦§ã‚’æç”»
        function renderSessionList() {
            const container = document.getElementById('sessionList');
            const searchQuery = document.getElementById('sessionSearch').value.toLowerCase();

            const filtered = sessions.filter(s => {
                if (!searchQuery) return true;
                if (s.name.toLowerCase().includes(searchQuery)) return true;
                return s.messages.some(m => m.content.toLowerCase().includes(searchQuery));
            });

            container.innerHTML = filtered.map(session => {
                const isActive = session.id === activeSessionId;
                const lastMessage = session.messages[session.messages.length - 1];
                const preview = lastMessage ? lastMessage.content.slice(0, 30) + '...' : 'ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãªã—';

                return `
                    <div class="session-item ${isActive ? 'active' : ''}" onclick="switchSession('${session.id}')">
                        <div class="session-info">
                            <div class="session-name">${escapeHtml(session.name)}</div>
                            <div class="session-preview">${escapeHtml(preview)}</div>
                        </div>
                        <div class="session-actions">
                            <button class="session-action-btn" onclick="exportSession('${session.id}', event)" title="ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ">ğŸ’¾</button>
                            <button class="session-action-btn" onclick="deleteSession('${session.id}', event)" title="å‰Šé™¤">ğŸ—‘ï¸</button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // æ¤œç´¢ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
        function filterSessions() {
            renderSessionList();
        }

        // ç¾åœ¨ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’å–å¾—
        function getCurrentSession() {
            return sessions.find(s => s.id === activeSessionId);
        }

        // ãƒãƒ£ãƒƒãƒˆã‚’æç”»
        function renderChat() {
            const chatArea = document.getElementById('chatArea');
            const session = getCurrentSession();

            if (!session || session.messages.length === 0) {
                chatArea.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">ğŸŒ¸</div>
                        <div class="empty-state-text">ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡ã—ã¦ãƒãƒ£ãƒƒãƒˆã‚’å§‹ã‚ã‚ˆã†ï¼</div>
                    </div>
                `;
                return;
            }

            chatArea.innerHTML = session.messages.map((msg, index) => {
                const label = msg.role === 'user' ? 'ã‚ãªãŸ' : 'ãƒ¬ã‚¤ã‚·ã‚¹';
                const isUser = msg.role === 'user';
                const isLastAssistant = msg.role === 'assistant' && index === session.messages.length - 1;

                // ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³
                let actions = '';
                if (isUser) {
                    actions = `<div class="message-actions">
                        <button class="message-action-btn" onclick="editMessage(${index})">âœï¸ ç·¨é›†</button>
                    </div>`;
                } else if (isLastAssistant) {
                    actions = `<div class="message-actions">
                        <button class="message-action-btn" onclick="regenerateResponse()">ğŸ”„ å†ç”Ÿæˆ</button>
                    </div>`;
                }

                return `
                    <div class="message ${msg.role}">
                        <div>
                            <div class="message-label">${label}</div>
                            <div class="message-bubble">${escapeHtml(msg.content)}</div>
                            ${actions}
                        </div>
                    </div>
                `;
            }).join('');

            chatArea.scrollTop = chatArea.scrollHeight;

            // åœ§ç¸®å±¥æ­´ã‚‚æ›´æ–°
            renderCompressedHistory();
        }

        // åœ§ç¸®å±¥æ­´ãƒ‘ãƒãƒ«ã‚’æç”»
        function renderCompressedHistory() {
            const historyList = document.getElementById('historyList');
            const session = getCurrentSession();

            if (!session || !session.compressedHistory || session.compressedHistory.length === 0) {
                historyList.innerHTML = '<div class="history-empty">ã¾ã åœ§ç¸®ã•ã‚ŒãŸå±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“</div>';
                return;
            }

            historyList.innerHTML = session.compressedHistory.map(item => `
                <div class="history-item">
                    <div class="history-item-turn">ã‚¿ãƒ¼ãƒ³ ${item.turn}</div>
                    ${escapeHtml(item.summary)}
                </div>
            `).join('');
        }

        // åœ§ç¸®å±¥æ­´ãƒ‘ãƒãƒ«ã®é–‹é–‰
        function toggleHistoryPanel() {
            const panel = document.getElementById('historyPanel');
            panel.classList.toggle('open');
        }

        // å·¦ã‚µã‚¤ãƒ‰ãƒãƒ¼ã®é–‹é–‰
        function toggleSidebar() {
            const sidebar = document.querySelector('.sidebar');
            sidebar.classList.toggle('open');
        }

        // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ç·¨é›†ï¼ˆè©²å½“ä½ç½®ä»¥é™ã‚’å‰Šé™¤ã—ã¦å…¥åŠ›æ¬„ã«ã‚»ãƒƒãƒˆï¼‰
        function editMessage(index) {
            const session = getCurrentSession();
            if (!session) return;

            const message = session.messages[index];
            if (!message || message.role !== 'user') return;

            // å…¥åŠ›æ¬„ã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ã‚»ãƒƒãƒˆ
            const input = document.getElementById('messageInput');
            input.value = typeof message.content === 'string' ? message.content : '';
            input.focus();

            // è©²å½“ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ä»¥é™ã‚’å‰Šé™¤
            session.messages = session.messages.slice(0, index);

            // åœ§ç¸®å±¥æ­´ã‚‚èª¿æ•´ï¼ˆå‰Šé™¤ã—ãŸã‚¿ãƒ¼ãƒ³ä»¥é™ã®åœ§ç¸®ã‚’å‰Šé™¤ï¼‰
            if (session.compressedHistory) {
                const deletedTurn = Math.floor(index / 2) + 1;
                session.compressedHistory = session.compressedHistory.filter(item => item.turn < deletedTurn);
            }

            saveSessions();
            renderChat();
            renderSessionList();
        }

        // æœ€å¾Œã®AIè¿”ç­”ã‚’å†ç”Ÿæˆ
        async function regenerateResponse() {
            const session = getCurrentSession();
            if (!session || session.messages.length < 2) return;

            // æœ€å¾ŒãŒassistantã‹ç¢ºèª
            const lastMsg = session.messages[session.messages.length - 1];
            if (lastMsg.role !== 'assistant') return;

            // æœ€å¾Œã®assistantãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å‰Šé™¤
            session.messages.pop();
            saveSessions();
            renderChat();

            // æœ€å¾Œã®userãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å–å¾—
            const lastUserMsg = session.messages[session.messages.length - 1];
            if (!lastUserMsg || lastUserMsg.role !== 'user') return;

            // APIã«å†ãƒªã‚¯ã‚¨ã‚¹ãƒˆï¼ˆsendMessageã¨åŒæ§˜ã®å‡¦ç†ï¼‰
            const apiKey = document.getElementById('apiKeyInput').value.trim();
            if (!apiKey) {
                showError('APIã‚­ãƒ¼ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }

            isLoading = true;
            updateSendButton();
            const loadingEl = showLoading();

            try {
                const historyMessages = getMessagesToSend(session);

                const systemMsg = getSystemMessage();
                const compressedText = getCompressedHistoryText(session);
                if (compressedText) {
                    systemMsg.content += compressedText;
                }

                const apiMessages = [systemMsg, ...historyMessages];

                const response = await fetch('https://api.openai.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiKey} `
                    },
                    body: JSON.stringify({
                        model: getSelectedModel(),
                        messages: apiMessages,
                        ...(getSelectedModel().startsWith('gpt-5')
                            ? { max_completion_tokens: 2000 }
                            : { max_tokens: 2000 })
                    })
                });

                loadingEl.remove();

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error?.message || 'APIã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
                }

                const data = await response.json();
                const assistantMessage = data.choices[0].message.content;

                if (data.usage) {
                    addTokensUsed(data.usage.prompt_tokens || 0, data.usage.completion_tokens || 0);
                }

                session.messages.push({ role: 'assistant', content: assistantMessage });
                saveSessions();
                renderChat();
                renderSessionList();

            } catch (error) {
                loadingEl.remove();
                showError(error.message);
            } finally {
                isLoading = false;
                updateSendButton();
            }
        }

        // ========================================
        // APIã‚­ãƒ¼ç®¡ç†
        // ========================================

        function saveApiKey() {
            const apiKey = document.getElementById('apiKeyInput').value.trim();
            if (!apiKey) {
                showApiStatus('APIã‚­ãƒ¼ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', false);
                return;
            }
            if (!apiKey.startsWith('sk-')) {
                showApiStatus('APIã‚­ãƒ¼ã¯ "sk-" ã§å§‹ã¾ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™', false);
                return;
            }
            localStorage.setItem('openai_api_key', apiKey);
            showApiStatus('âœ“ APIã‚­ãƒ¼ã‚’ä¿å­˜ã—ã¾ã—ãŸ', true);
        }

        function loadApiKey() {
            const savedKey = localStorage.getItem('openai_api_key');
            if (savedKey) {
                document.getElementById('apiKeyInput').value = savedKey;
                showApiStatus('âœ“ ä¿å­˜æ¸ˆã¿ã®APIã‚­ãƒ¼ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ', true);
            }
        }

        function showApiStatus(message, isSaved) {
            const status = document.getElementById('apiStatus');
            status.textContent = message;
            status.className = 'api-status' + (isSaved ? ' saved' : '');
        }

        // ========================================
        // ãƒ¢ãƒ‡ãƒ«é¸æŠç®¡ç†
        // ========================================

        function saveModelSelection() {
            const model = document.getElementById('modelSelect').value;
            localStorage.setItem('openai_model', model);
        }

        function loadModelSelection() {
            const saved = localStorage.getItem('openai_model');
            if (saved) {
                document.getElementById('modelSelect').value = saved;
            }
        }

        function getSelectedModel() {
            return document.getElementById('modelSelect').value;
        }

        // ========================================
        // ãƒãƒ£ãƒƒãƒˆæ©Ÿèƒ½
        // ========================================

        async function sendMessage() {
            const input = document.getElementById('messageInput');
            const message = input.value.trim();
            const apiKey = document.getElementById('apiKeyInput').value.trim();
            const session = getCurrentSession();

            // ãƒ•ã‚¡ã‚¤ãƒ«ã‹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒã‚ã‚Œã°é€ä¿¡å¯èƒ½
            if ((!message && !pendingFile) || !session) return;
            if (!apiKey) {
                showError('APIã‚­ãƒ¼ã‚’å…¥åŠ›ã—ã¦ä¿å­˜ã—ã¦ãã ã•ã„');
                return;
            }
            if (isLoading) return;

            // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’æ§‹ç¯‰ï¼ˆãƒ•ã‚¡ã‚¤ãƒ«å¯¾å¿œï¼‰
            const userMessage = buildMessageWithFile(message);

            // è¡¨ç¤ºç”¨ã®ãƒ†ã‚­ã‚¹ãƒˆã‚’ä½œæˆ
            let displayText = message;
            if (pendingFile) {
                if (pendingFile.type === 'image') {
                    displayText = message ? `${message} \n\n[ğŸ“· ç”»åƒ: ${pendingFile.name}]` : `[ğŸ“· ç”»åƒ: ${pendingFile.name}]`;
                } else {
                    displayText = message ? `${message} \n\n[ğŸ“„ ãƒ•ã‚¡ã‚¤ãƒ«: ${pendingFile.name}]` : `[ğŸ“„ ãƒ•ã‚¡ã‚¤ãƒ«: ${pendingFile.name}]`;
                }
            }

            // å±¥æ­´ã«ã¯è¡¨ç¤ºç”¨ãƒ†ã‚­ã‚¹ãƒˆã‚’ä¿å­˜
            session.messages.push({ role: 'user', content: displayText });
            saveSessions();
            renderChat();
            renderSessionList();

            input.value = '';
            resizeTextarea(input);

            // ãƒ•ã‚¡ã‚¤ãƒ«ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’ã‚¯ãƒªã‚¢
            clearFilePreview();

            // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º
            isLoading = true;
            updateSendButton();

            try {
                // é€ä¿¡ç”¨ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é…åˆ—ã‚’æ§‹ç¯‰
                const historyMessages = getMessagesToSend(session);
                const messagesWithoutLast = historyMessages.slice(0, -1);

                // ã‚·ã‚¹ãƒ†ãƒ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã«åœ§ç¸®å±¥æ­´ã‚’è¿½åŠ 
                const systemMsg = getSystemMessage();
                const compressedText = getCompressedHistoryText(session);
                if (compressedText) {
                    systemMsg.content += compressedText;
                }

                const apiMessages = [systemMsg, ...messagesWithoutLast, userMessage];

                const response = await fetch('https://api.openai.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiKey}`
                    },
                    body: JSON.stringify({
                        model: getSelectedModel(),
                        messages: apiMessages,
                        stream: true,
                        ...(getSelectedModel().startsWith('gpt-5')
                            ? { max_completion_tokens: 2000 }
                            : { max_tokens: 2000 })
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error?.message || 'APIã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
                }

                // ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’å‡¦ç†
                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let assistantMessage = '';
                let promptTokens = 0;
                let completionTokens = 0;

                // ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®è¡¨ç¤ºç”¨è¦ç´ ã‚’ä½œæˆ
                const chatArea = document.getElementById('chatArea');
                const messageDiv = document.createElement('div');
                messageDiv.className = 'message assistant';
                messageDiv.innerHTML = `
                    <div>
                        <div class="message-label">ãƒ¬ã‚¤ã‚·ã‚¹</div>
                        <div class="message-bubble" id="streamingBubble"></div>
                    </div>
                `;
                chatArea.appendChild(messageDiv);
                const streamingBubble = document.getElementById('streamingBubble');

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;

                    const chunk = decoder.decode(value);
                    const lines = chunk.split('\n');

                    for (const line of lines) {
                        if (line.startsWith('data: ')) {
                            const data = line.slice(6);
                            if (data === '[DONE]') continue;

                            try {
                                const parsed = JSON.parse(data);
                                const delta = parsed.choices[0]?.delta?.content;
                                if (delta) {
                                    assistantMessage += delta;
                                    streamingBubble.innerHTML = escapeHtml(assistantMessage);
                                    chatArea.scrollTop = chatArea.scrollHeight;
                                }
                                // ä½¿ç”¨é‡æƒ…å ±ã‚’å–å¾—ï¼ˆæœ€å¾Œã®ãƒãƒ£ãƒ³ã‚¯ã«å«ã¾ã‚Œã‚‹ã“ã¨ãŒã‚ã‚‹ï¼‰
                                if (parsed.usage) {
                                    promptTokens = parsed.usage.prompt_tokens || 0;
                                    completionTokens = parsed.usage.completion_tokens || 0;
                                }
                            } catch (e) {
                                // JSONãƒ‘ãƒ¼ã‚¹ã‚¨ãƒ©ãƒ¼ã¯ç„¡è¦–
                            }
                        }
                    }
                }

                // streamingBubbleã®IDã‚’å‰Šé™¤
                streamingBubble.removeAttribute('id');

                // å†ç”Ÿæˆãƒœã‚¿ãƒ³ã‚’è¿½åŠ 
                const actionsDiv = document.createElement('div');
                actionsDiv.className = 'message-actions';
                actionsDiv.innerHTML = `<button class="message-action-btn" onclick="regenerateResponse()">ğŸ”„ å†ç”Ÿæˆ</button>`;
                messageDiv.querySelector('div').appendChild(actionsDiv);

                // ãƒˆãƒ¼ã‚¯ãƒ³ä½¿ç”¨é‡ã‚’è¿½åŠ ï¼ˆæ¦‚ç®—ï¼‰
                if (promptTokens > 0 || completionTokens > 0) {
                    addTokensUsed(promptTokens, completionTokens);
                } else {
                    // ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°ã§ã¯ä½¿ç”¨é‡ãŒè¿”ã‚‰ãªã„ã“ã¨ãŒã‚ã‚‹ã®ã§æ¦‚ç®—
                    const estimatedTokens = estimateTokenCount(assistantMessage);
                    addTokensUsed(0, estimatedTokens);
                }

                session.messages.push({ role: 'assistant', content: assistantMessage });
                saveSessions();
                renderSessionList();

                // å¿…è¦ã«å¿œã˜ã¦å±¥æ­´ã‚’åœ§ç¸®ï¼ˆéåŒæœŸã§å®Ÿè¡Œï¼‰
                compressHistoryIfNeeded(session, apiKey);

            } catch (error) {
                showError(error.message);
            } finally {
                isLoading = false;
                updateSendButton();
            }
        }

        function showLoading() {
            const chatArea = document.getElementById('chatArea');
            const loadingDiv = document.createElement('div');
            loadingDiv.className = 'message assistant';
            loadingDiv.id = 'loadingIndicator';
            loadingDiv.innerHTML = `
                <div>
                    <div class="message-label">ãƒ¬ã‚¤ã‚·ã‚¹</div>
                    <div class="loading">
                        <div class="loading-dot"></div>
                        <div class="loading-dot"></div>
                        <div class="loading-dot"></div>
                    </div>
                </div>
            `;
            chatArea.appendChild(loadingDiv);
            chatArea.scrollTop = chatArea.scrollHeight;
            return loadingDiv;
        }

        function showError(message) {
            const chatArea = document.getElementById('chatArea');
            const existingError = chatArea.querySelector('.error-message');
            if (existingError) existingError.remove();

            const errorDiv = document.createElement('div');
            errorDiv.className = 'error-message';
            errorDiv.textContent = 'âš ï¸ ' + message;
            chatArea.appendChild(errorDiv);
            chatArea.scrollTop = chatArea.scrollHeight;
        }

        function updateSendButton() {
            const btn = document.getElementById('sendBtn');
            btn.disabled = isLoading;
        }


        // ========================================
        // ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
        // ========================================

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            // æ”¹è¡Œã‚’<br>ã«å¤‰æ›
            return div.innerHTML.replace(/\n/g, '<br>');
        }

        function handleKeyDown(event) {
            // Enterã‚­ãƒ¼ã§ã¯é€ä¿¡ã—ãªã„ï¼ˆé€ä¿¡ãƒœã‚¿ãƒ³ã®ã¿ã§é€ä¿¡ï¼‰
            // Shift+Enterã§æ”¹è¡Œã¯å¯èƒ½
        }

        function autoResizeTextarea() {
            const textarea = document.getElementById('messageInput');
            textarea.addEventListener('input', () => resizeTextarea(textarea));
        }

        function resizeTextarea(textarea) {
            textarea.style.height = 'auto';
            textarea.style.height = Math.min(textarea.scrollHeight, 120) + 'px';
        }
    </script>
</body>

</html>
